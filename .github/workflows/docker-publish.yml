name: deploy
on:
  repository_dispatch:
    types: [lynx-release]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Lynx Release Tag'
        required: true
env:
  RELEASE_TAG: ${{ github.event.client_payload.tag }}

jobs:
  publish-docker-images:

    runs-on: ubuntu-latest

    steps:

    - name: Set release tag in case of manual run
      if: env.RELEASE_TAG != ''
      run: |
        echo "LYNX_RELEASE_TAG=${{ github.event.inputs.new_engine_version }}" >> $GITHUB_ENV

    - name: Inject slug/short variables
      uses: rlespinasse/github-slug-action@v3.x

    - name: TestDownload executable
      uses: dsaltares/fetch-gh-release-asset@0.06
      with:
        repo: "eduherminio/FileParser"
        version: "v2.1.1"
        file: "FileParser.2.1.1.nupkg"
        target: "artifacts/nuget.zip"
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Download executable
      uses: dsaltares/fetch-gh-release-asset@0.06
      with:
        repo: "lynx-chess/Lynx"
        version: "${{ env.RELEASE_TAG }}"
        file: "Lynx-0.1.0-alpha.1-linux-arm64.zip"
        target: "artifacts/lynx-arm64.zip"
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Inspect
      run: ls -al artifacts

    - name: Inspect
      run: ls -al artifacts/Lynx-linux-arm64

    - name: Log in to registry
        # This is where you will update the PAT to GITHUB_TOKEN
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
